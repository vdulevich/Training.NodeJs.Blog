<%var articlesFeedPanelId = 'articlesList', articlesFeedItemTemplateId = 'articlesListItemTemplate'; %>

<div id="<%=articlesFeedPanelId%>" >
    <div class="ch-article-panel panel panel-default">
        <div class="panel-heading">
            Articles
        </div>
        <div class="ch-feed-actiles list-group">
        </div>
        <input class="btn btn-lg btn-default btn-block" value="Load More" type="button"/>
    </div>
    <script type="text/html" class="hidden" id="articlesFeedItemTmpl">
        <div class="list-group-item" data-readonly="${readonly}">
            <div class="photo-col">
                <img class="img-circle" src="images/no-photo.png"/>
            </div>
            <div class="content-col">
                <div class="list-group-item-heading row">
                    <div class="col-lg-10"><strong class="panel-title">${title}</strong><a href="/article/${id}">view article</a></div>
                    <div class="col-lg-2 author-label">Created by <a href="profile/${userId}"><strong>${author}</strong></a></div>
                </div>
                <p class="list-group-item-text">${content}</p>
            </div>
            <div class="author-rate">
                <select>
                    {{each [0,1,2,3,4,5,6,7,8,9]}}
                        <option value="${$value}" ${$item.isSelected(rating, $value)}>${$value}</option>
                    {{/each}}
                </select>
            </div>
        </div>
    </script>

    <script type="text/javascript">
        var articlesFeedStartDate = Date.now();
        function initArticleFeed(){
            var articlesPanel = $('#<%=articlesFeedPanelId%>'),
                articlesList = articlesPanel.find('.list-group'),
                articleLoadBtn = articlesPanel.find('.btn');

            articleLoadBtn.on('click', function(){
                bindArticleFeed(articlesList.find('.list-group-item').length);
            });
        };
        function bindArticleFeed(startIndex){
            var articlesPanel = $('#<%=articlesFeedPanelId%>'),
                articlesList = articlesPanel.find('.list-group'),
                articleLoadBtn = articlesPanel.find('.btn'),
                articlesTpl = articlesPanel.find('#articlesFeedItemTmpl');

            $.ajax('/article/findByLessThenDate', {
                type: "POST",
                data: {
                    startdate: articlesFeedStartDate,
                    startIndex: startIndex || 0,
                    pageSize: 5
                },
                statusCode: {
                    200: function (data) {
                        $(articlesTpl.tmpl(data, {
                            isSelected:function(rating, index){
                                return rating == index ? 'selected' : '';
                            }
                        })
                        .appendTo(articlesList))
                        .find('select')
                        .barrating({
                            theme: 'bars-movie',
                            readonly: true,
                            initialRating: 0
                        });
                        if(data.length == 0){
                            articleLoadBtn.prop("disabled",true);
                        }
                    }
                }
            }).always(function () {
                articlesList.unmask();
            })
        };
        initArticleFeed();
        bindArticleFeed();
    </script>
</div>