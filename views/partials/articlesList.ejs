<%var articlesPanelId = 'articlesList', articlesListItemTemplateId = 'articlesListItemTemplate'; %>

<div id="<%=articlesPanelId%>" >
    <div class="ch-article-panel panel panel-default">
        <div class="panel-heading">
            Articles
            <a href="#"><span class="pull-right glyphicon glyphicon-plus"></span></a>
        </div>
        <div class="ch-article-list list-group">
        </div>
    </div>
    <div id="<%=articlesListItemTemplateId%>" type="text/x-jquery-tmpl" class="hidden">
        <a class="ch-list-group-item list-group-item" articleId="${_id}">
            <div class="list-group-list-content">
                <h4 class="list-group-item-heading">${title}</h4>
                <p class="list-group-item-text">${content}</p>
            </div>
            <div class="ch-article-list-edit">
                <span class="glyphicon glyphicon-edit"></span>
                <span class="glyphicon glyphicon-trash"></span>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        function initArticleList(){
            var articlesPanel = $('#<%=articlesPanelId%>'),
                articlesTpl = $('#<%=articlesListItemTemplateId%>'),
                articlesList = $('#<%=articlesPanelId%>').find('.ch-article-list');

            articlesPanel.find('.glyphicon-plus').on('click', onAdd);

            function onAdd(){
                articlesPanel.mask('Loading...');
                $.ajax('/article/create', {
                    type: "POST",
                    data: { title: 'No title', content: 'No content' },
                    statusCode: {
                        200: function(data){
                            var row = articlesTpl.tmpl(data).appendTo(articlesList);
                            initHandlers(row);
                        }
                    }
                }).always(function () {
                    articlesPanel.unmask();
                });
            }

            function onEdit(){
                var row = $(event.target).closest('a[articleId]'),
                        id = row.attr('articleId');
                articlesPanel.mask('Loading...');
                $.ajax('/article/getEditDlg', {
                    type: "POST",
                    data: { id: id },
                    statusCode: {
                        200: function (data) {
                            $(data)
                                .appendTo('body')
                                .modal()
                                .on('hidden.bs.modal', function () {
                                    $(this).remove();
                                })
                                .on('articleSaved', function(event, data){
                                    var item = $.tmplItem(row);
                                    item.data = data;
                                    item.update();
                                    initHandlers($(item.nodes));
                                });
                        }
                    }
                }).always(function () {
                    articlesPanel.unmask();
                });
            }

            function onDelete(){
                var row = $(event.target).closest('a[articleId]'),
                        id = row.attr('articleId');
                articlesPanel.mask('Loading...');
                $.ajax('/article/delete', {
                    type: "POST",
                    data: { id: id },
                    statusCode: {
                        200: function(){ row.remove(); }
                    }
                }).always(function () {
                    articlesPanel.unmask();
                });
            };

            function initHandlers(element) {
                var articleEdit = element.find('.glyphicon-edit'),
                    articleDelete = element.find('.glyphicon-trash');
                articleEdit.on('click', onEdit);
                articleDelete.on('click', onDelete);
            };

            initHandlers(articlesPanel);
        }

        (function bindArticleList(){
            var articlesList = $('#<%=articlesPanelId%>').find('.ch-article-list');
            var articlesTpl = $('#<%=articlesListItemTemplateId%>');
            $.ajax('/article/find', {
                type: "POST",
                data: { },
                statusCode: {
                    200: function (data) {
                        data.forEach(function(item){
                            articlesTpl.tmpl(item).appendTo(articlesList);
                        });
                        initArticleList();
                    }
                }
            }).always(function () {
                articlesList.unmask();
            })
        })();
    </script>
</div>